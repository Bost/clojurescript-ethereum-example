<!doctype html>
<html lang="en">
    <head>
        <meta charset='utf-8'>
        <link rel="stylesheet" href="./css/styles.css">
        <script type="text/javascript" src="js/web3.min.js"></script>
        <script type="text/javascript">
         function addElem() {
             nouveauDiv = document.createElement("div");
             nouveauDiv.innerHTML = "<button onClick='sendMoney()'>send money</button>";

             mon_div = document.getElementById("container");
             document.body.insertBefore(nouveauDiv, mon_div);
         }

         var Web3 = require('web3');
         var web3 = new Web3();

         web3.setProvider(new web3.providers.HttpProvider('http://localhost:8545'));
         var coinbase = web3.eth.coinbase;
         var balance = web3.eth.getBalance(coinbase);
         console.log("web3.eth.coinbase: "+balance.toString(10));

         /*
            contract token {
            mapping (address => uint) public coinBalanceOf;
            event CoinTransfer(address sender, address receiver, uint amount);
            function token(uint supply) {
            coinBalanceOf[msg.sender] = supply;
            }
            function sendCoin(address receiver, uint amount) returns(bool sufficient) {
            if (coinBalanceOf[msg.sender] < amount) return false;
            coinBalanceOf[msg.sender] -= amount;
            coinBalanceOf[receiver] += amount;
            CoinTransfer(msg.sender, receiver, amount);
            return true;
            }
            }
          */

         var tokenSource = 'contract token {mapping (address => uint) public coinBalanceOf; event CoinTransfer(address sender, address receiver, uint amount); function token(uint supply) {coinBalanceOf[msg.sender] = supply;} function sendCoin(address receiver, uint amount) returns(bool sufficient) {if (coinBalanceOf[msg.sender] < amount) return false; coinBalanceOf[msg.sender] -= amount; coinBalanceOf[receiver] += amount; CoinTransfer(msg.sender, receiver, amount); return true;}}';

         var tokenCompiled = web3.eth.compile.solidity(tokenSource);
         var path;
         for (var name in tokenCompiled) {
             path = name;
             /* console.log("tokenCompiled: "+name);*/
         }
         console.log("tokenCompiled. path: "+path);

         var supply = 10000;
         var tokenContract = web3.eth.contract(tokenCompiled[path].info.abiDefinition);

         var src = web3.eth.accounts[0];
         web3.personal.unlockAccount(src, "m");

         var token = tokenContract.new(
             supply,
             {
                 from: src,
                 data: tokenCompiled[path].code,
                 gas: 1000000
             }, function(e, contract){
                 if (!e) {
                     if (!contract.address) {
                         console.log("Contract transaction send: TxHash: " + contract.transactionHash + " waiting to be mined...");
                     }
                     else {
                         console.log("Contract mined! Address: " + contract.address);
                         addElem();
                     }
                 }
                 else {
                     console.log("ERROR: "+e);
                 }
             });

         function sendMoney() {
             var event = token.CoinTransfer({}, '', function(error, result){
                 if (!error) {
                     console.log(
                         "\n"+
                         "Coin transfer: " + result.args.amount + " tokens sent!"+
                         " New balances: \n"+
                         " Sender:   " + result.args.sender   + " " + token.coinBalanceOf.call(result.args.sender) + " tokens \n"+
                         " Receiver: " + result.args.receiver + " " + token.coinBalanceOf.call(result.args.receiver) + " tokens" );
                 }
                 else {
                     console.log("ERROR: "+error);
                 }
             });

             var amount = 1000;
             var src = web3.eth.accounts[0];
             var dst = web3.eth.accounts[1];

             web3.personal.unlockAccount(src,"m");
             console.log("Account unlocked: "+src);

             console.log("Sending "+amount+" coins from: "+src+" to "+dst);
             var txhash = token.sendCoin.sendTransaction(dst, amount, {from: src});
             console.log("Transaction hash: "+txhash);
             console.log("Waiting for the event 'CoinTransfer' to occure...");
         }
        </script>
    </head>
  <body>
      Open console to watch... (Ctrl + Shift + J)
      <div id="container"></div>

      <!-- <div id="app"></div> -->
      <!-- <script src="./js/compiled/app.js"></script> -->
      <!-- <script>clojurescript_ethereum_example.core.init();</script> -->
  </body>
</html>
